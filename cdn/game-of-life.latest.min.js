/*
 * The MIT License (MIT)
 * 
 * Copyright (c) 2014 Stefan Dollase
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
function GameOfLife(e){this.createState=function(){return new AppStateBinder({autoplay:{flag:"autoplay",changed:function(e){t.updateAutoplay()}},pattern:{option:this.getPatternNames(),changed:function(e){t.updatePattern()}},patternData:{json:"json",changed:function(e){t.updatePattern()}},nogrid:{flag:"nogrid",changed:function(e){t.updateShowGrid()}},border:{option:["torus","alive","dead"],changed:function(e){t.updateBorder()}},speed:{parse:function(e){if(!t.stringContains(e,"ms")){return false}try{var n=e.split("ms");if(n.length!==2||n[1]!==""){return false}return t.parseIntMinMax(n[0],0,1e4)}catch(r){return false}},stringify:function(e){return e+"ms"},changed:function(e){t.updateSpeed()}},size:{parse:function(e){if(!t.stringContains(e,"x")||t.stringContains(e,"+")){return false}try{var n=e.split("x");if(n.length!==2){return false}return{width:t.parseIntMinMax(n[0],1,500),height:t.parseIntMinMax(n[1],1,500)}}catch(r){return false}},stringify:function(e){return e.width+"x"+e.height},changed:function(e){t.updateSize()}},patternOffset:{parse:function(e){if(!t.stringContains(e,"x")||!t.stringContains(e,"+")){return false}var n=e.split("+");if(n.length!==2||n[0]!==""){return false}try{var r=n[1].split("x");if(r.length!==2){return false}return{j:t.parseIntMinMax(r[0],0,499),i:t.parseIntMinMax(r[1],0,499)}}catch(i){return false}},stringify:function(e){return"+"+e.j+"x"+e.i},changed:function(e){t.updatePatternOffset()}},rules:{parse:function(e){if(!t.stringContains(e,"/")){return false}var n=e.split("/");if(n.length!==2){return false}var r={};r.keepAlive=new Array(9);r.revive=new Array(9);for(var i=0;i<9;i++){r.keepAlive[i]=n[0].indexOf(""+i)>=0}for(var i=0;i<9;i++){r.revive[i]=n[1].indexOf(""+i)>=0}return r},stringify:function(e){var t="";for(var n=0;n<e.keepAlive.length;n++){if(e.keepAlive[n]){t+=n}}t+="/";for(var n=0;n<e.revive.length;n++){if(e.revive[n]){t+=n}}return t},changed:function(e){t.updateRules()}}})};this.parseIntMinMax=function(e,t,n){if(e===""||isNaN(e)){throw"NaN"}var r=parseInt(e);if(r<t){r=t}else if(r>n){r=n}return r};this.stringContains=function(e,t){return e.indexOf(t)>=0};this.isString=function(e){return typeof e=="string"||e instanceof String};this.overwriteJSObject=function(e,t){for(var n in t){e[n]=t[n]}return e};this.updateAutoplay=function(){if(n.isSet("autoplay")){n.unset("autoplay");this.start()}};this.updatePattern=function(){var e=n.get("pattern");var t=n.get("patternData");if(e==="random"){this.pattern="random"}else if(e!==false){this.pattern=this.namedPatterns[e]}else if(t!==false){this.pattern=t}else if(this.defaultSettings.pattern==="random"){this.pattern="random"}else if(this.isString(this.defaultSettings.pattern)){this.pattern=this.namedPatterns[this.defaultSettings.pattern]}else if(this.defaultSettings.pattern!==false){this.pattern=this.defaultSettings.pattern}else{this.pattern={}}this.initPattern();this.drawAllCells()};this.updatePatternOffset=function(){this.setStateOrDefault("patternOffset");this.initPattern();this.drawAllCells()};this.updateSize=function(){this.setStateOrDefault("size");this.setupMatrices();this.resize();this.initPattern();this.drawAllCells()};this.updateRules=function(){this.setStateOrDefault("rules")};this.updateSpeed=function(){this.setStateOrDefault("speed");this.restartIfRunning()};this.updateShowGrid=function(){this.showGrid=!n.isSet("nogrid");this.resize();this.drawAllCells()};this.updateBorder=function(){this.setStateOrDefault("border")};this.setStateOrDefault=function(e){var t=n.get(e);if(t===false){this[e]=this.defaultSettings[e]}else{this[e]=t}};this.setupMatrices=function(){if(this.currentGeneration===undefined||this.currentGeneration.length!==this.size.height||this.currentGeneration[0].length!==this.size.width){this.currentGeneration=this.createArray(false);this.nextGeneration=this.createArray(false);this.drawOverlay=this.createArray(0)}else{this.initArray(this.currentGeneration,false);this.initArray(this.nextGeneration,false);this.initArray(this.drawOverlay,0)}};this.setupSettings=function(e){if(e.settings){this.overwriteJSObject(this.defaultSettings,e.settings)}this.overwriteJSObject(this,this.defaultSettings)};this.setupModes=function(e){if(e.modes){this.modes=[];for(var t=0;t<e.modes.length;t++){if(e.modes[t]==="defaults"){this.modes=this.modes.concat(this.defaultModes)}else{this.modes.push(e.modes[t])}}}else{this.modes=this.defaultModes}};this.setupUI=function(e){this.html={};if(this.isString(e.container)){this.html.container=document.getElementById(e.container)}else{this.html.container=e.container}this.setupUIWindow();this.html.startButton=this.setupUIButton("Start","toggleRunning");this.setupUIButton("Step","step");this.setupUIButton("Clear","initNamedPattern",["clean"]);this.setupUIButton("Random","initNamedPattern",["random"]);this.setupUIButton("Export","exportCurrentGeneration");this.setupUIButton("Quicker","increaseSpeed",[.5]);this.setupUIButton("Slower","increaseSpeed",[2]);this.setupUIButton("Toggle Grid","toggleGrid");this.setupUIButton("Toggle Border","toggleBorder");this.setupUICanvas();this.setupUIModeList()};this.setupUIWindow=function(){window.addEventListener("resize",function(){t.resize();t.drawAllCells()},false)};this.setupUIButton=function(e,n,r){r=r||[];var i=document.createElement("button");i.innerHTML=e;var s;if(this.isString(n)){s=function(){t[n].apply(t,r)}}else{s=function(){n.apply(t,r)}}i.addEventListener("click",s,false);this.html.container.appendChild(i);return i};this.setupUICanvas=function(){this.html.canvas=document.createElement("canvas");this.html.canvas.addEventListener("mousemove",function(e){t.mouseMove(e)});this.html.canvas.addEventListener("mousedown",function(e){t.mouseMove(e)});this.html.canvas.addEventListener("mouseup",function(e){t.mouseUp(e)});this.html.container.appendChild(this.html.canvas);this.html.context=this.html.canvas.getContext("2d")};this.setupUIModeList=function(){this.html.modeList=document.createElement("ul");this.html.modeList.style.listStyle="none";this.html.modeList.style.marginLeft=0;for(var e=0;e<this.modes.length;e++){var t=document.createElement("li");var n=document.createElement("a");n.innerHTML=this.modes[e].title;n.setAttribute("href","#"+this.modes[e].href);t.appendChild(n);this.html.modeList.appendChild(t)}this.html.container.appendChild(this.html.modeList)};this.initNamedPattern=function(e){n.set("pattern",e,true)};this.exportCurrentGeneration=function(){if(this.currentGenerationChanged){var e=this.size.height;var t=this.size.width;for(var r=0;r<this.size.height;r++){for(var i=0;i<this.size.width;i++){if(this.currentGeneration[r][i]){if(e>r){e=r}if(t>i){t=i}}}}if(e===this.size.height){n.unset("patternOffset");n.unset("patternData");n.set("pattern","clean");return}var s={};for(var r=0;r<this.size.height;r++){for(var i=0;i<this.size.width;i++){if(this.currentGeneration[r][i]){if(s[r-e]){}else{s[r-e]=[]}s[r-e].push(i-t)}}}if(e>0||t>0){n.set("patternOffset",{i:e,j:t})}else{n.unset("patternOffset")}n.set("patternData",s);n.unset("pattern")}};this.increaseSpeed=function(e){var t=this.speed*e|0;if(t<1){t=1}else if(t>1e4){t=1e4}n.set("speed",t)};this.toggleGrid=function(){n.toggle("nogrid")};this.toggleBorder=function(){n.toggle("border")};this.initPattern=function(){var e=this.isRunning();this.stop();this.setupMatrices();if(this.pattern==="random"){this.createRandomPattern()}else{this.createDataPattern(this.patternOffset.i,this.patternOffset.j,this.pattern)}delete this.currentGenerationChanged;if(e){this.start()}};this.createRandomPattern=function(){for(var e=0;e<this.size.height;e++){for(var t=0;t<this.size.width;t++){this.currentGeneration[e][t]=Math.random()<.5}}};this.createDataPattern=function(e,t,n){for(var r in n){var i=parseInt(r);for(var s=0;s<n[i].length;s++){var o=e+i;var u=t+parseInt(n[i][s]);if(o>=0&&o<this.size.height&&u>=0&&u<this.size.width){this.currentGeneration[o][u]=true}}}};this.createArray=function(e){var t=new Array(this.size.height);for(var n=0;n<this.size.height;n++){t[n]=new Array(this.size.width);for(var r=0;r<this.size.width;r++){t[n][r]=e}}return t};this.initArray=function(e,t){for(var n=0;n<e.length;n++){for(var r=0;r<e[n].length;r++){e[n][r]=t}}return e};this.resize=function(){this.html.canvas.width=this.html.canvas.parentNode.offsetWidth;this.html.canvas.height=this.html.canvas.width*this.size.height/this.size.width;if(this.showGrid){this.cellOffset=1}else{this.cellOffset=0}var e=(this.html.canvas.width-2+this.cellOffset)/this.size.width;var t=(this.html.canvas.height-2+this.cellOffset)/this.size.height;this.toXCoordinateArray=new Array(this.size.width+1);for(var n=0;n<=this.size.width;n++){this.toXCoordinateArray[n]=(n*e|0)+1-this.cellOffset}this.toYCoordinateArray=new Array(this.size.height+1);for(var r=0;r<=this.size.height;r++){this.toYCoordinateArray[r]=(r*t|0)+1-this.cellOffset}this.cellWidth=new Array(this.size.width);for(var n=0;n<this.size.width;n++){this.cellWidth[n]=this.toXCoordinateArray[n+1]-this.toXCoordinateArray[n]-this.cellOffset}this.cellHeight=new Array(this.size.height);for(var r=0;r<this.size.height;r++){this.cellHeight[r]=this.toYCoordinateArray[r+1]-this.toYCoordinateArray[r]-this.cellOffset}this.toICellArray=new Array(this.html.canvas.height);for(var i=0;i<=this.html.canvas.height;i++){this.toICellArray[i]=(i-1)/t|0}this.toJCellArray=new Array(this.html.canvas.width);for(var s=0;s<=this.html.canvas.width;s++){this.toJCellArray[s]=(s-1)/e|0}this.toITorusCoordinateArray=new Array(this.size.height+2);this.toITorusCoordinateArray[0]=this.size.height-1;for(var r=0;r<=this.size.height;r++){this.toITorusCoordinateArray[r+1]=r}this.toITorusCoordinateArray[this.size.height+1]=0;this.toJTorusCoordinateArray=new Array(this.size.width+2);this.toJTorusCoordinateArray[0]=this.size.width-1;for(var n=0;n<=this.size.width;n++){this.toJTorusCoordinateArray[n+1]=n}this.toJTorusCoordinateArray[this.size.width+1]=0;this.drawGrid();this.drawBorder()};this.drawGrid=function(){if(this.showGrid){for(var e=1;e<this.size.height;e++){this.drawHorizontalLine(e)}for(var t=1;t<this.size.width;t++){this.drawVerticalLine(t)}this.html.context.strokeStyle="#eee";this.html.context.stroke()}};this.drawBorder=function(){this.drawHorizontalLine(0);this.drawHorizontalLine(this.size.height);this.drawVerticalLine(0);this.drawVerticalLine(this.size.width);this.html.context.strokeStyle="#eee";this.html.context.stroke()};this.drawHorizontalLine=function(e){var t=this.toYCoordinateArray[e];this.html.context.moveTo(0,t);this.html.context.lineTo(this.html.canvas.width,t)};this.drawVerticalLine=function(e){var t=this.toXCoordinateArray[e];this.html.context.moveTo(t,0);this.html.context.lineTo(t,this.html.canvas.height)};this.drawAllCells=function(){for(var e=0;e<this.size.height;e++){for(var t=0;t<this.size.width;t++){this.drawCell(e,t,this.currentGeneration[e][t])}}};this.drawCell=function(e,t,n){var r=this.toXCoordinateArray[t]+this.cellOffset;var i=this.toYCoordinateArray[e]+this.cellOffset;var s=this.cellWidth[t];var o=this.cellHeight[e];if(this.drawOverlay[e][t]===this.mouseDownCounter){this.html.context.fillStyle="#33c";this.html.context.fillRect(r,i,s,o)}else if(this.drawOverlay[e][t]===-this.mouseDownCounter){this.html.context.fillStyle="#77e";this.html.context.fillRect(r,i,s,o)}else if(n){this.html.context.fillStyle="#000";this.html.context.fillRect(r,i,s,o)}else{this.html.context.clearRect(r,i,s,o)}};this.step=function(){for(var e=0;e<this.size.height;e++){for(var t=0;t<this.size.width;t++){var n=this.countNeighbors(e,t);this.nextGeneration[e][t]=this.currentGeneration[e][t]&&this.rules.keepAlive[n]||this.rules.revive[n];if(this.nextGeneration[e][t]!==this.currentGeneration[e][t]){this.drawCell(e,t,this.nextGeneration[e][t])}}}var r=this.currentGeneration;this.currentGeneration=this.nextGeneration;this.nextGeneration=r;this.currentGenerationChanged=true};this.countNeighbors=function(e,t){if(this.border==="torus"){return this.countNeighborsTorus(e,t)}else if(this.border==="alive"){return this.countNeighborsBorderAlive(e,t)}else if(this.border==="dead"){return this.countNeighborsBorderDead(e,t)}};this.countNeighborsTorus=function(e,t){var n=0;for(var r=0;r<=2;r++){for(var i=0;i<=2;i++){if((r!=1||i!=1)&&this.currentGeneration[this.toITorusCoordinateArray[e+r]][this.toJTorusCoordinateArray[t+i]]){n++}}}return n};this.countNeighborsBorderAlive=function(e,t){var n=8;if(e>=1){if(!this.currentGeneration[e-1][t]){n--}if(t>=1&&!this.currentGeneration[e-1][t-1]){n--}if(t<this.size.width-1&&!this.currentGeneration[e-1][t+1]){n--}}if(e<this.size.height-1){if(!this.currentGeneration[e+1][t]){n--}if(t>=1&&!this.currentGeneration[e+1][t-1]){n--}if(t<this.size.width-1&&!this.currentGeneration[e+1][t+1]){n--}}if(t>=1&&!this.currentGeneration[e][t-1]){n--}if(t<this.size.width-1&&!this.currentGeneration[e][t+1]){n--}return n};this.countNeighborsBorderDead=function(e,t){var n=0;if(e>=1){if(this.currentGeneration[e-1][t]){n++}if(t>=1&&this.currentGeneration[e-1][t-1]){n++}if(t<this.size.width-1&&this.currentGeneration[e-1][t+1]){n++}}if(e<this.size.height-1){if(this.currentGeneration[e+1][t]){n++}if(t>=1&&this.currentGeneration[e+1][t-1]){n++}if(t<this.size.width-1&&this.currentGeneration[e+1][t+1]){n++}}if(t>=1&&this.currentGeneration[e][t-1]){n++}if(t<this.size.width-1&&this.currentGeneration[e][t+1]){n++}return n};this.start=function(){if(!this.isRunning()){this.timer=window.setInterval(function(){t.step()},this.speed);document.title="▶ "+document.title;this.html.startButton.innerHTML="Stop"}};this.stop=function(){if(this.isRunning()){window.clearInterval(this.timer);this.timer=false;document.title=document.title.substring(2);this.html.startButton.innerHTML="Start"}};this.restartIfRunning=function(){if(this.isRunning()){this.stop();this.start()}};this.toggleRunning=function(){if(this.isRunning()){this.stop()}else{this.start()}};this.isRunning=function(){return!(this.timer===false)};this.mouseMove=function(e){if(e.buttons==1){if(this.mouseDownCounter%2==0){this.mouseDownCounter++}var t=this.html.canvas.getBoundingClientRect();var n=this.toICellArray[e.clientY-t.top|0];var r=this.toJCellArray[e.clientX-t.left|0];if(this.currentGeneration[n][r]&&this.drawOverlay[n][r]!==-this.mouseDownCounter){this.drawOverlay[n][r]=-this.mouseDownCounter;this.drawCell(n,r,this.currentGeneration[n][r])}else if(!this.currentGeneration[n][r]&&this.drawOverlay[n][r]!==this.mouseDownCounter){this.drawOverlay[n][r]=this.mouseDownCounter;this.drawCell(n,r,this.currentGeneration[n][r])}}else{if(this.mouseDownCounter%2==1){this.mouseUp(e)}}};this.mouseUp=function(e){var t=this.mouseDownCounter;this.mouseDownCounter++;for(var n=0;n<this.size.height;n++){for(var r=0;r<this.size.width;r++){if(this.drawOverlay[n][r]===t){this.currentGeneration[n][r]=true}else if(this.drawOverlay[n][r]===-t){this.currentGeneration[n][r]=false}}}this.currentGenerationChanged=true;this.drawAllCells()};this.getPatternNames=function(){var e=["random"];for(var t in this.namedPatterns){e.push(t)}return e};this.namedPatterns={clean:{},cell1:{0:[4],1:[2,3,5,6],2:[1,6],3:[0,7],4:[0,1,2,4,5,6],5:[2,3,5]},cell2:{0:[2,3,4],1:[1,2,3,4,5],2:[0,1,2,3,4],3:[0,1,2,3,4],4:[1,2]},nice:{0:[0,1,2,4,5,6],1:[0,6],2:[0,1,2,4,5,6]},h2o:{0:[0,3,9,10,11,12],1:[0,3,9,12],2:[0,3,6,9,12],3:[0,1,2,3,5,6,7,9,12],4:[0,3,6,9,12],5:[0,3,9,12],6:[0,3,9,10,11,12],7:[4,5],8:[5],9:[4],10:[4,5]},"glider-gun":{0:[24],1:[22,24],2:[12,13,20,21,34,35],3:[11,15,20,21,34,35],4:[0,1,10,16,20,21],5:[0,1,10,14,16,17,22,24],6:[10,16,24],7:[11,15],8:[12,13]},line:{0:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199]}};this.defaultModes=[{title:"23/3 - Conway's Original Game Of Life",href:"23/3|random"},{title:"23/3 - Conway's Original Game Of Life - Nice",href:"23/3|nice|+20x20"},{title:"23/3 - Conway's Original Game Of Life - Glider Gun",href:"23/3|glider-gun"},{title:"1357/1357 - Copyworld",href:"1357/1357|cell1|+20x20"},{title:"12345/3 - Labyrinth",href:"12345/3|cell1|+20x20"},{title:"0123/01234 - Blink",href:"0123/01234|random"},{title:"01234678/0123478 - Anti-Conway",href:"01234678/0123478|random"},{title:"02468/02468 - Anti-Copyworld",href:"02468/02468|cell1|+20x20"},{title:"02468/02468 - Anti-Copyworld - Clean",href:"02468/02468|clean|+20x20"},{title:"012345678/3 - Growing Cancer",href:"012345678/3|cell1|+20x20"},{title:"45678/5678 - Majorities",href:"45678/5678|random"},{title:"2468/2468 - H₂O - Chemical Balance",href:"2468/2468|h2o|+20x20"},{title:"23/3 - Line",href:"23/3|line|+100x110|400x220|1ms|nogrid"}];this.mouseDownCounter=2;this.timer=false;this.defaultSettings={rules:{keepAlive:[false,false,true,true,false,false,false,false,false],revive:[false,false,false,true,false,false,false,false,false]},size:{width:100,height:50},patternOffset:{i:0,j:0},pattern:{},speed:100,showGrid:true,border:"dead"};var t=this;var n=this.createState();this.setupSettings(e);this.setupModes(e);this.setupUI(e);this.initPattern();this.resize();n.fireChangedForAll();this.drawAllCells()}